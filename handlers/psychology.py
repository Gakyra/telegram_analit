from aiogram import Router, F
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
import random

router = Router()

# FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
class PsychologyState(StatesGroup):
    waiting_for_topic = State()
    showing_tip = State()

# –¢–µ–º—ã –∏ —Å–æ–≤–µ—Ç—ã
TIPS = {
    "üìå –≠–º–æ—Ü–∏–∏": [
        "üò§ –≠–º–æ—Ü–∏–∏ ‚Äî –≥–ª–∞–≤–Ω—ã–π –≤—Ä–∞–≥ —Ç—Ä–µ–π–¥–µ—Ä–∞. –£—á–∏—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.",
        "üò± –ü–∞–Ω–∏–∫–∞ –Ω–∞ —Ä—ã–Ω–∫–µ ‚Äî —Å–∏–≥–Ω–∞–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –Ω–µ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π.",
        "üòå –£–º–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ ‚Äî –∫–ª—é—á –∫ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–º—É —É—Å–ø–µ—Ö—É.",
        "üß† –°—Ç—Ä–∞—Ö –∏ –∂–∞–¥–Ω–æ—Å—Ç—å –∏—Å–∫–∞–∂–∞—é—Ç –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ. –î–æ–≤–µ—Ä—è–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –Ω–µ –æ—â—É—â–µ–Ω–∏—è–º.",
        "üòÆ‚Äçüí® –ù–µ —Ä–µ–∞–≥–∏—Ä—É–π –Ω–∞ –∫–∞–∂–¥–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Ä—ã–Ω–∫–∞ ‚Äî —ç—Ç–æ –ø—É—Ç—å –∫ –≤—ã–≥–æ—Ä–∞–Ω–∏—é.",
        "üòµ‚Äçüí´ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–∞—á–µ–ª–∏ –º–µ—à–∞—é—Ç –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –ü–∏—à–∏ –ø–ª–∞–Ω –∏ —Å–ª–µ–¥—É–π –µ–º—É."
    ],
    "üìà –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞": [
        "üìä –°–ª–µ–¥—É–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –∞ –Ω–µ —à—É–º—É. –ù–æ–≤–æ—Å—Ç–∏ ‚Äî –Ω–µ –≤—Å–µ–≥–¥–∞ —Å–∏–≥–Ω–∞–ª.",
        "üßò –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –≤–∞–∂–Ω–µ–µ –ø—Ä–æ–≥–Ω–æ–∑–∞. –£–º–µ–π –∂–¥–∞—Ç—å –∏ –Ω–µ –ø–∞–Ω–∏–∫–æ–≤–∞—Ç—å.",
        "üõë –ù–µ —É—Å—Ä–µ–¥–Ω—è–π —É–±—ã—Ç–∫–∏ –±–µ–∑ –ø–ª–∞–Ω–∞. –≠—Ç–æ –ª–æ–≤—É—à–∫–∞ –¥–ª—è —ç–º–æ—Ü–∏–π.",
        "üìã –í–µ–¥–∏ –∂—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫ ‚Äî —ç—Ç–æ –∑–µ—Ä–∫–∞–ª–æ —Ç–≤–æ–µ–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã.",
        "üìå –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ –ø—Ä–∏–≤—ã—á–∫–∞, –∞ –Ω–µ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ."
    ],
    "üßò –ú—ã—à–ª–µ–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞": [
        "üß† –ú—ã—à–ª–µ–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞ ‚Äî —ç—Ç–æ —Ç–µ—Ä–ø–µ–Ω–∏–µ, –∞–Ω–∞–ª–∏–∑ –∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è.",
        "üìâ –ü–æ—Ç–µ—Ä–∏ ‚Äî —á–∞—Å—Ç—å –∏–≥—Ä—ã. –ì–ª–∞–≤–Ω–æ–µ ‚Äî —É—á–∏—Ç—å—Å—è –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è.",
        "üßò –£–º–µ–π –≤—ã–π—Ç–∏ –∏–∑ –ø–æ–∑–∏—Ü–∏–∏. –§–∏–∫—Å–∞—Ü–∏—è –ø—Ä–∏–±—ã–ª–∏ ‚Äî —Ç–æ–∂–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è.",
        "üß© –ù–µ –∏—â–∏ –∏–¥–µ–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ ‚Äî –∏—â–∏ —Ö–æ—Ä–æ—à—É—é –∏–¥–µ—é –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é.",
        "üß≠ –ù–µ –≥–æ–Ω–∏—Å—å –∑–∞ —Ç—Ä–µ–Ω–¥–∞–º–∏ ‚Äî —Å—Ç—Ä–æ–π —Å–≤–æ—é –∫–∞—Ä—Ç—É."
    ],
    "üéØ –¶–µ–ª–∏": [
        "üéØ –°—Ç–∞–≤—å —Ü–µ–ª–∏: –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, —Å—Ä–æ–∫, —Ä–∏—Å–∫ ‚Äî –∏ –ø—Ä–æ–≤–µ—Ä—è–π –∏—Ö —Ä–µ–≥—É–ª—è—Ä–Ω–æ.",
        "üìÖ –ü–ª–∞–Ω–∏—Ä—É–π: –∫–æ–≥–¥–∞ –≤—Ö–æ–¥–∏—Ç—å, –∫–æ–≥–¥–∞ –≤—ã—Ö–æ–¥–∏—Ç—å, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—å.",
        "üìå –ë–µ–∑ —Ü–µ–ª–∏ ‚Äî –Ω–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏. –ë–µ–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ‚Äî —Ç–æ–ª—å–∫–æ —Ö–∞–æ—Å.",
        "üìà –¶–µ–ª–∏ –ø–æ–º–æ–≥–∞—é—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —à—É–º –∏ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å—É—Ç–∏.",
        "üß≠ –¶–µ–ª—å ‚Äî —ç—Ç–æ –∫–æ–º–ø–∞—Å, –∞ –Ω–µ —è–∫–æ—Ä—å."
    ]
}

# –ú–µ–Ω—é –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏
@router.message(F.text == "üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è")
async def show_psychology_menu(message: Message, state: FSMContext):
    await state.set_state(PsychologyState.waiting_for_topic)
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üìå –≠–º–æ—Ü–∏–∏"), KeyboardButton(text="üìà –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞")],
            [KeyboardButton(text="üßò –ú—ã—à–ª–µ–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞"), KeyboardButton(text="üéØ –¶–µ–ª–∏")],
            [KeyboardButton(text="üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")],
            [KeyboardButton(text="üîô –ù–∞–∑–∞–¥")]
        ],
        resize_keyboard=True,
        input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É"
    )
    await message.answer("üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:", reply_markup=kb)

# –í—ã–±–æ—Ä —Ç–µ–º—ã ‚Üí —Å–æ–≤–µ—Ç
@router.message(PsychologyState.waiting_for_topic, F.text.in_(TIPS.keys()))
async def show_tip(message: Message, state: FSMContext):
    topic = message.text
    await state.update_data(topic=topic)
    await state.set_state(PsychologyState.showing_tip)

    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–ï—â—ë")],
            [KeyboardButton(text="üîô –ù–∞–∑–∞–¥")]
        ],
        resize_keyboard=True
    )
    tip = random.choice(TIPS[topic])
    await message.answer(tip, reply_markup=kb)

# –ï—â—ë —Å–æ–≤–µ—Ç
@router.message(PsychologyState.showing_tip, F.text == "–ï—â—ë")
async def show_another_tip(message: Message, state: FSMContext):
    data = await state.get_data()
    topic = data.get("topic")
    tip = random.choice(TIPS[topic])
    await message.answer(tip)

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
@router.message(F.text == "üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
async def show_recommendations(message: Message):
    text = (
        "üìö *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π:*\n\n"
        "üî∏ _–ö–Ω–∏–≥–∏:_\n"
        "‚Ä¢ ¬´–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è¬ª ‚Äî –î–∂–æ–Ω –ù–æ—Ñ—Å–∏–Ω–≥–µ—Ä\n"
        "‚Ä¢ ¬´–î—É–º–∞–π –º–µ–¥–ª–µ–Ω–Ω–æ‚Ä¶ —Ä–µ—à–∞–π –±—ã—Å—Ç—Ä–æ¬ª ‚Äî –î–∞–Ω–∏—ç–ª—å –ö–∞–Ω–µ–º–∞–Ω\n"
        "‚Ä¢ ¬´–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ —Ñ–∏–Ω–∞–Ω—Å—ã¬ª ‚Äî –î–∂–µ–π–º—Å –ú–æ–Ω—Ç–∏–µ—Ä\n\n"
        "üî∏ _YouTube:_\n"
        "‚Ä¢ Rational Reminder\n"
        "‚Ä¢ Aswath Damodaran\n"
        "‚Ä¢ Investopedia\n\n"
        "üî∏ _–°—Ç–∞—Ç—å–∏:_\n"
        "‚Ä¢ ¬´Why Investors Behave Irrationally¬ª ‚Äî CFA Institute\n"
        "‚Ä¢ ¬´The Psychology of Market Cycles¬ª ‚Äî Morningstar\n\n"
        "üí° –≠—Ç–∏ —Ä–µ—Å—É—Ä—Å—ã –ø–æ–º–æ–≥—É—Ç –ø—Ä–æ–∫–∞—á–∞—Ç—å –º—ã—à–ª–µ–Ω–∏–µ, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —à—É–º—É."
    )
    await message.answer(text, parse_mode="Markdown")

# –ù–∞–∑–∞–¥
@router.message(F.text == "üîô –ù–∞–∑–∞–¥")
async def go_back(message: Message, state: FSMContext):
    await state.clear()
    from handlers.start import send_main_menu
    await send_main_menu(message)
